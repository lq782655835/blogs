(window.webpackJsonp=window.webpackJsonp||[]).push([[135],{327:function(t,s,n){"use strict";n.r(s);var a=n(9),o=Object(a.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"虚拟dom算法库-snabbdom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#虚拟dom算法库-snabbdom","aria-hidden":"true"}},[t._v("#")]),t._v(" 虚拟dom算法库 - snabbdom")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/snabbdom/snabbdom",target:"_blank",rel:"noopener noreferrer"}},[t._v("snabbdom"),n("OutboundLink")],1),t._v("是一个虚拟dom算法库，它的特点是效率高、可扩展，Vue 虚拟DOM就是基于该库进行改造。snabbdom核心代码就几百行，但里面的一些设计非常优秀。")]),t._v(" "),n("h2",{attrs:{id:"基本使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本使用","aria-hidden":"true"}},[t._v("#")]),t._v(" 基本使用")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" snabbdom "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'snabbdom'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 选择modules（可以理解为插件），返回patch方法")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" patch "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" snabbdom"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("、\n  "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'snabbdom/modules/props'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// for setting properties on DOM elements")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'snabbdom/modules/style'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// handles styling on elements with support for animations")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'snabbdom/modules/eventlisteners'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// attaches event listeners")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" h "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'snabbdom/h'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token keyword"}},[t._v("default")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 帮助创建vnode实例")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" container "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("getElementById")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'container'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" vnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'div#container.two.classes'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("on"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("click"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" someFn"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'span'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("style"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("fontWeight"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'bold'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'This is bold'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{attrs:{class:"token string"}},[t._v("' and this is just normal text'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'a'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("props"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("href"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'/foo'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'I\\'ll take you places!'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// vnode挂载到指定container下")]),t._v("\n"),n("span",{attrs:{class:"token function"}},[t._v("patch")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("container"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" newVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'div#container.two.classes'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("on"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("click"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" anotherEventHandler"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'span'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("style"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("fontWeight"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'normal'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fontStyle"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'italic'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'This is now italic type'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{attrs:{class:"token string"}},[t._v("' and this is still just normal text'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{attrs:{class:"token function"}},[t._v("h")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'a'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("props"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("href"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'/bar'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'I\\'ll take you places!'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 对比vnode，并更新node")]),t._v("\n"),n("span",{attrs:{class:"token function"}},[t._v("patch")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h2",{attrs:{id:"基本数据结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本数据结构","aria-hidden":"true"}},[t._v("#")]),t._v(" 基本数据结构")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// VNode数据结构")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("VNode")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  sel"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 选择器")]),t._v("\n  data"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNodeData "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 保存属性、样式、事件等")]),t._v("\n  children"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" string"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//  子节点")]),t._v("\n  elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Node "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//  对应的真实dom节点")]),t._v("\n  text"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//  文本节点")]),t._v("\n  key"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Key "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 唯一key")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// VNodeData数据格式")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("VNodeData")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  props"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Props"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 设置el对象上属性，不会反馈到html标签上")]),t._v("\n  attrs"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Attrs"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 设置el上的atrrs，会反馈到html标签上")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Classes"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// css class")]),t._v("\n  style"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNodeStyle"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// css style")]),t._v("\n  dataset"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Dataset"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// html dataset")]),t._v("\n  on"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" On"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 事件")]),t._v("\n  hero"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Hero"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  attachData"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" AttachData"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hook"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  key"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Key"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ns"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// for SVGs")]),t._v("\n  fn"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=>")]),t._v(" VNode"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// for thunks")]),t._v("\n  args"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("any"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// for thunks")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" any"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// for any other 3rd party module")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"核心源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#核心源码","aria-hidden":"true"}},[t._v("#")]),t._v(" 核心源码")]),t._v(" "),n("p",[n("code",[t._v("在初始化init时，注入一些内置的modules模块")]),t._v("，比如处理dom event的eventlisteners.ts、处理html class的class.ts。往后在虚拟DOM patch时，会在合适的时间触发modules的回调函数。内置的modules源码都放在src/modules文件夹下。")]),t._v(" "),n("p",[t._v("初始化init返回patch方法，帮助diff vdom并更新真实的dom，它分两种参数传递：")]),t._v(" "),n("ol",[n("li",[n("code",[t._v("参数传递Node和VNode")]),t._v("。此时会把VNode渲染成真实的DOM并插入到Node节点里面。")]),t._v(" "),n("li",[n("code",[t._v("参数传递VNode和VNode")]),t._v("。如果两者VNode不等（此时的不等理解为：oldVNode.key !== newNode.key || oldVNode.sel !== newNode.sel），则参照上面规则：新的DOM插入以及老的DOM销毁。如果两者VNode相等，则需要diff vdom，详细看下面。")])]),t._v(" "),n("p",[t._v("src/snabbdom.ts：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keyof Module"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token string"}},[t._v("'create'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'update'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'remove'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'destroy'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'pre'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'post'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("init")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("modules"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("Partial"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("Module"),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" domApi"),n("span",{attrs:{class:"token operator"}},[t._v("?")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token constant"}},[t._v("DOMAPI")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("/**\n  init绑定module hooks事件，并等待patch时，在合适时间触发\n  cbs = {\n      create: [styleCreateHook, eventCreateHook, ...],\n      update: [styleUpateHook, eventUpateHook, ...]\n  }\n  **/")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" number"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" j"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" number"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cbs "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" ModuleHooks"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" api"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token constant"}},[t._v("DOMAPI")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" htmlDomApi"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("j "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" modules"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("j"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" modules"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("j"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// modules中定义的hook")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("any"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("push")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("patch")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNode "),n("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v(" Element"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNode "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" number"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Node"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parent"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Node"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNodeQueue "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// pre 前置回调函数执行")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pre"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pre"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 为Element时")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),n("span",{attrs:{class:"token function"}},[t._v("isVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      oldVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("emptyNodeAt")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("sameVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 当是相同Vnode时，patch更新（涉及到diff算法）")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 不相同的Vnode时，直接利用新的 Vnode 创建对应的真实 DOM 节点，然后移除旧的 Vnode 所代表的真实 DOM 节点")]),t._v("\n      elm "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Node"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      parent "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("parentNode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 根据 vnode 创建新的真实 DOM 节点，绑定到vnode.elm上。")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// create事件回调在此发生")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("createElm")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 插入并替换原有 DOM 节点")]),t._v("\n        api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Node"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("nextSibling")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token function"}},[t._v("removeVnodes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// destroy事件回调再此发生")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" VNodeData"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hook "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Hooks"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("insert "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" any"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// post 后置回调都执行")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v(" cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("post"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" cbs"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("post"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("虚拟dom的diff有个前提：diff只发生在相同的层级。")]),t._v("基于这个假设，我们可以 按照层级分解树，这大大简化了复杂度，大到接近 O(n) 的复杂度。")]),t._v(" "),n("p",[t._v("当两个vnode相同（key和sel没变），对比两个vnode进行patch更新。当是简单节点（如文本节点时）或者VNode新增删除时，只需要实现对应DOM操作即可。当需要两个VNode对比时，就会复杂的多。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token comment"}},[t._v("// 更新dom")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 主要是根据vnode，去改变oldVnode对应的DOM，最大程度复用已存在的DOM")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VNodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 保存旧 vnode 的 DOM 引用")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" elm "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Node"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldCh "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" ch "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果新的 vnode 节点不是一个文本节点")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isUndef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果两个 vnode 节点都有子节点")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ch"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// @important 并且子节点不一样，开始 diff")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldCh "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" ch"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("updateChildren")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldCh "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ch "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ch"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果只有新的 vnode 有子节点，设置旧的 vnode 的内容为空")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("setTextContent")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("''")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 添加插入新的 DOM 节点")]),t._v("\n        "),n("span",{attrs:{class:"token function"}},[t._v("addVnodes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ch "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ch "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果只有旧的 vnode 有子节点，则移除所有子节点")]),t._v("\n        "),n("span",{attrs:{class:"token function"}},[t._v("removeVnodes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldCh "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldCh "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Array"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("VNode"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isDef")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果旧 vnode 是个文本节点，并且新 vnode 也没有子节点，则清空旧 vnode 的内容")]),t._v("\n        api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("setTextContent")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("''")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果新的 vnode 节点是文本节点，如果文本内容和旧 vnode 不一样则设置新的值")]),t._v("\n      api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("setTextContent")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" string"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("对于 children （数组）的比较，因为同层是很可能有移动的，顺序比较会无法最大化复用已有的 DOM。所以"),n("code",[t._v("snabbdom的vnode有 key 字断，用来追踪这种顺序变动。")])]),t._v(" "),n("p",[t._v("最复杂的是两个vnode相同（key和sel相同），同时两者的子节点children不一样，这也是现实场景中最常出现的情况。snabbdom最核心的dom diff算法在"),n("code",[t._v("updateChildren")]),t._v("方法中。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("updateChildren")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldEndIdx "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" newEndIdx "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" newEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" oldKeyToIdx\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" idxInOld\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" elmToMove\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("let")]),t._v(" before\n\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 遍历 oldCh 和 newCh 来比较和更新")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" oldEndIdx "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" newStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v("<=")]),t._v(" newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 1⃣️ 首先检查 4 种情况，保证 oldStart/oldEnd/newStart/newEnd")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 这 4 个 vnode 非空，左侧的 vnode 为空就右移下标，右侧的 vnode 为空就左移 下标。")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      oldStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("oldStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      oldEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      newEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("/**\n     * 2⃣️ 然后 oldStartVnode/oldEndVnode/newStartVnode/newEndVnode 两两比较，\n     * 对有相同 vnode 的 4 种情况执行对应的 patch 逻辑。\n     * - 如果同 start 或同 end 的两个 vnode 是相同的（情况 1 和 2），\n     *   说明不用移动实际 dom，直接更新 dom 属性／children 即可；\n     * - 如果 start 和 end 两个 vnode 相同（情况 3 和 4），\n     *   那说明发生了 vnode 的移动，同理我们也要移动 dom。\n     */")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 1. 如果 oldStartVnode 和 newStartVnode 相同（key相同），执行 patch")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isSameVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 不需要移动 dom")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      oldStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("oldStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 2. 如果 oldEndVnode 和 newEndVnode 相同，执行 patch")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isSameVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 不需要移动 dom")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      oldEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      newEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 3. 如果 oldStartVnode 和 newEndVnode 相同，执行 patch")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isSameVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 把获得更新后的 (oldStartVnode/newEndVnode) 的 dom 右移，移动到")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// oldEndVnode 对应的 dom 的右边。为什么这么右移？")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// （1）oldStartVnode 和 newEndVnode 相同，显然是 vnode 右移了。")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// （2）若 while 循环刚开始，那移到 oldEndVnode.elm 右边就是最右边，是合理的；")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// （3）若循环不是刚开始，因为比较过程是两头向中间，那么两头的 dom 的位置已经是")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("//     合理的了，移动到 oldEndVnode.elm 右边是正确的位置；")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// （4）记住，oldVnode 和 vnode 是相同的才 patch，且 oldVnode 自己对应的 dom")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("//     总是已经存在的，vnode 的 dom 是不存在的，直接复用 oldVnode 对应的 dom。")]),t._v("\n      api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("nextSibling")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      oldStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("oldStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      newEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 4. 如果 oldEndVnode 和 newStartVnode 相同，执行 patch")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("isSameVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 这里是左移更新后的 dom，原因参考上面的右移。")]),t._v("\n      api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldEndVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      oldEndVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 3⃣️ 最后一种情况：4 个 vnode 都不相同，那么我们就要")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 1. 从 oldCh 数组建立 key --\x3e index 的 map。")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 2. 只处理 newStartVnode （简化逻辑，有循环我们最终还是会处理到所有 vnode），")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("//    以它的 key 从上面的 map 里拿到 index；")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 3. 如果 index 存在，那么说明有对应的 old vnode，patch 就好了；")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 4. 如果 index 不存在，那么说明 newStartVnode 是全新的 vnode，直接")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("//    创建对应的 dom 并插入。")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果 oldKeyToIdx 不存在，创建 old children 中 vnode 的 key 到 index 的")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 映射，方便我们之后通过 key 去拿下标。")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldKeyToIdx "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" undefined"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        oldKeyToIdx "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("createKeyToOldIdx")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 尝试通过 newStartVnode 的 key 去拿下标")]),t._v("\n      idxInOld "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldKeyToIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 下标不存在，说明 newStartVnode 是全新的 vnode。")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("idxInOld "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 那么为 newStartVnode 创建 dom 并插入到 oldStartVnode.elm 的前面。")]),t._v("\n        api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("createElm")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{attrs:{class:"token comment"}},[t._v("// 下标存在，说明 old children 中有相同 key 的 vnode，")]),t._v("\n      "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        elmToMove "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idxInOld"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果 type 不同，没办法，只能创建新 dom；")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elmToMove"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),n("span",{attrs:{class:"token operator"}},[t._v("!==")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("createElm")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// type 相同（且key相同），那么说明是相同的 vnode，执行 patch。")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),n("span",{attrs:{class:"token function"}},[t._v("patchVnode")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("elmToMove"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("idxInOld"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" undefined\n          api"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" elmToMove"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartVnode"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        newStartVnode "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token operator"}},[t._v("++")]),t._v("newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 上面的循环结束后（循环条件有两个），处理可能的未处理到的 vnode。")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果是 new vnodes 里有未处理的（oldStartIdx > oldEndIdx")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 说明 old vnodes 先处理完毕）")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    before "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("newEndIdx"),n("span",{attrs:{class:"token operator"}},[t._v("+")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("newEndIdx"),n("span",{attrs:{class:"token operator"}},[t._v("+")]),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm\n    "),n("span",{attrs:{class:"token function"}},[t._v("addVnodes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" before"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 相反，如果 old vnodes 有未处理的，删除 （为处理 vnodes 对应的） 多余的 dom。")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newStartIdx "),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" newEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token function"}},[t._v("removeVnodes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldCh"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldStartIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" oldEndIdx"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),n("p",[t._v("两个假设：")]),t._v(" "),n("ol",[n("li",[t._v("相同的节点类型，有相同DOM结构；不同的节点类型，不同DOM结构。")]),t._v(" "),n("li",[t._v("同一层次的节点组，有唯一的key标识。")])]),t._v(" "),n("p",[t._v("流程：")]),t._v(" "),n("ul",[n("li",[t._v("新旧两个VNode对比，如果两个相同(vnode1.key === vnode2.key && vnode1.sel === vnode2.sel)，vue中（a.key === b.key && a.tag === b.tag）\n"),n("ul",[n("li",[t._v("如果是文字节点，更新文字即可")]),t._v(" "),n("li",[t._v("非文字节点，判断子节点\n"),n("ul",[n("li",[t._v("如果新老VNode都有子节点，需要使用双向链表处理两个Childrens")]),t._v(" "),n("li",[t._v("如果只有新的子节点，增加子节点DOM")]),t._v(" "),n("li",[t._v("如果只有旧的子节点，删除老的子节点")])])])])]),t._v(" "),n("li",[t._v("如果不同，增加新DOM，去除老DOM。")])])])},[],!1,null,null,null);o.options.__file="vue-code-2.snabbdom.md";s.default=o.exports}}]);